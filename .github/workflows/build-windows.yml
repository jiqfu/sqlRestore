name: Build Windows EXE

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to upload to (e.g. build-win-20251216)"
        required: true
        default: "build-win"
      prerelease:
        description: "Mark release as prerelease"
        required: false
        default: "true"
  push:
    tags:
      - "build-win-*"

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          python -m pip install pyinstaller pyperclip sqlparse

      - name: Build exe (onefile, windowed)
        run: |
          python -m PyInstaller -F -w sqlRestoreUI.py

      - name: Package artifact
        shell: pwsh
        run: |
          $exe = "dist/sqlRestoreUI.exe"
          if (!(Test-Path $exe)) { throw "Build output not found: $exe" }
          Compress-Archive -Path $exe -DestinationPath "sqlRestoreUI-windows-x86_64.zip" -Force

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: sqlRestoreUI-windows-x86_64
          path: sqlRestoreUI-windows-x86_64.zip

      - name: Create/Update release and upload asset
        env:
          GH_TOKEN: ${{ github.token }}
          # For push(tag) events, `inputs` context doesn't exist.
          # Use github.event.inputs.* which is safe across event types.
          TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}
          PRERELEASE: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.prerelease || 'true' }}
        shell: pwsh
        run: |
          $tag = "$env:TAG"
          if ([string]::IsNullOrWhiteSpace($tag)) { throw "tag is required" }

          $isPrerelease = "$env:PRERELEASE"

          # Create release if not exists
          gh release view $tag 2>$null
          if ($LASTEXITCODE -ne 0) {
            $notes = @"
Windows build generated by GitHub Actions.

- Artifact: sqlRestoreUI-windows-x86_64.zip
- Build: onefile PyInstaller
"@
            $args = @("release","create",$tag,"sqlRestoreUI-windows-x86_64.zip","--title","sqlRestoreUI Windows x86_64","--notes",$notes)
            if ($isPrerelease -eq "true") { $args += "--prerelease" }
            gh @args
          } else {
            gh release upload $tag "sqlRestoreUI-windows-x86_64.zip" --clobber
          }
