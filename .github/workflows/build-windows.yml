name: Build Windows EXE

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to upload to (e.g. build-win-20251216)"
        required: true
        default: "build-win"
      prerelease:
        description: "Mark release as prerelease"
        required: false
        type: boolean
        default: true
  push:
    tags:
      - "build-win-*"

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          python -m pip install pyinstaller pyperclip sqlparse

      - name: Build exe (onefile, windowed)
        run: |
          python -m PyInstaller -F -w sqlRestoreUI.py

      - name: Package artifact
        shell: pwsh
        run: |
          $exe = "dist/sqlRestoreUI.exe"
          if (!(Test-Path $exe)) { throw "Build output not found: $exe" }
          Compress-Archive -Path $exe -DestinationPath "sqlRestoreUI-windows-x86_64.zip" -Force

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: sqlRestoreUI-windows-x86_64
          path: sqlRestoreUI-windows-x86_64.zip

      - name: Create/Update release and upload asset
        env:
          GH_TOKEN: ${{ github.token }}
          INPUT_TAG: ${{ inputs.tag }}
          INPUT_PRERELEASE: ${{ inputs.prerelease }}
          REF_NAME: ${{ github.ref_name }}
          EVENT_NAME: ${{ github.event_name }}
        shell: pwsh
        run: |
          # Determine tag name:
          # - workflow_dispatch: use inputs.tag
          # - push tag event: use github.ref_name
          $tag = if ($env:EVENT_NAME -eq "workflow_dispatch") { "$env:INPUT_TAG" } else { "$env:REF_NAME" }
          if ([string]::IsNullOrWhiteSpace($tag)) { throw "tag is required" }

          # Determine prerelease flag:
          # - workflow_dispatch: respect inputs.prerelease
          # - push tag event: default to true
          $isPrerelease = if ($env:EVENT_NAME -eq "workflow_dispatch") { "$env:INPUT_PRERELEASE" } else { "true" }

          # Create release if not exists
          gh release view $tag 2>$null
          if ($LASTEXITCODE -ne 0) {
            $notes = @"
Windows build generated by GitHub Actions.

- Artifact: sqlRestoreUI-windows-x86_64.zip
- Build: onefile PyInstaller
"@
            $args = @("release","create",$tag,"sqlRestoreUI-windows-x86_64.zip","--title","sqlRestoreUI Windows x86_64","--notes",$notes)
            if ($isPrerelease -eq "true") { $args += "--prerelease" }
            gh @args
          } else {
            gh release upload $tag "sqlRestoreUI-windows-x86_64.zip" --clobber
          }
